CREATE USER HLF IDENTIFIED BY HLF;

GRANT CONNECT, RESOURCE TO HLF;

GRANT CREATE SESSION TO HLF;

SELECT 1 from dual;

CREATE TABLE HLF.BC_VALID_TX_WRITE_SET (
BLOCK NUMBER(6) NOT NULL,
TXSEQ NUMBER(6) NOT NULL,
ITEM  NUMBER(6) NOT NULL,
KEY   VARCHAR2(100) NOT NULL,
VALUE VARCHAR2(4000),
IS_DELETE CHAR(1)
)
TABLESPACE USERS

SELECT * FROM HLF.BC_VALID_TX_WRITE_SET

INSERT INTO HLF.BC_VALID_TX_WRITE_SET VALUES (1,0,0,'akey','avalue',null)

COMMIT

SELECT * FROM HLF.BC_VALID_TX_WRITE_SET

DELETE HLF.BC_VALID_TX_WRITE_SET

TRUNCATE TABLE HLF.BC_VALID_TX_WRITE_SET

SELECT count(*) FROM HLF.BC_VALID_TX_WRITE_SET

DROP INDEX HLF.BC_VALID_TX_WRITE_SET_UK

CREATE UNIQUE INDEX HLF.BC_VALID_TX_WRITE_SET_UK
ON HLF.BC_VALID_TX_WRITE_SET(BLOCK, TXSEQ, ITEM)
TABLESPACE USERS

CREATE INDEX HLF.BC_VALIDA_TX_WRITE_SET_KEY
ON HLF.BC_VALID_TX_WRITE_SET(KEY)
TABLESPACE USERS

SELECT * FROM (
SELECT x.*, count(*) over(PARTITION BY BLOCK, TXSEQ, ITEM) AS COUNT_KEY
FROM HLF.BC_VALID_TX_WRITE_SET x
) WHERE COUNT_KEY > 1

SELECT * FROM hlf.BC_VALID_TX_WRITE_SET
WHERE block > 50000 AND
KEY LIKE 'per:%#jur:%'

SELECT distinct KEY, count_ch
FROM (
SELECT KEY, count(*) OVER(PARTITION BY key) AS count_ch 
FROM hlf.BC_VALID_TX_WRITE_SET
) x
WHERE count_ch between 2 AND 4
ORDER BY 1

SELECT * FROM hlf.BC_VALID_TX_WRITE_SET
WHERE block > 50000 AND
KEY LIKE 'per:%#imp:5900'

UPDATE hlf.BC_VALID_TX_WRITE_SET
SET KEY = replace(KEY, 20002614953, 27269391702)
WHERE KEY LIKE 'per:20002614953%'

UPDATE hlf.BC_VALID_TX_WRITE_SET
SET VALUE = replace(VALUE, 20002614953, 27269391702)
WHERE KEY LIKE 'per:27269391702#per'
AND BLOCK = 53410

select * from hlf.BC_VALID_TX_WRITE_SET
where key LIKE 'per:20002614953%'


SELECT * FROM hlf.BC_VALID_TX_WRITE_SET WHERE KEY LIKE 'per:27269391702%' ORDER BY 1,2,3

DELETE hlf.BC_VALID_TX_WRITE_SET WHERE block=53410 AND KEY = 'per:27269391702#wit'

SELECT * FROM hlf.BC_VALID_TX_WRITE_SET WHERE block >= 53406 AND KEY LIKE 'per:2%'

commit

SELECT DISTINCT cuit FROM 
(
SELECT substr(KEY,5,11) AS cuit,
count(DISTINCT block) over(PARTITION BY substr(KEY,5,11)) AS blocks
FROM HLF.BC_VALID_TX_WRITE_SET 
)
WHERE blocks > 2

20104249729
20208575148
20777777778
20182480593
27000006721
30711599025

block_start = 50901
block_stop = 53739
block_processed = 

20142035929
